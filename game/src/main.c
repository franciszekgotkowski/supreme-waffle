#include <engine/scene.h>
#include <assert.h>
#include <engine/font.h>
#include <engine/range.h>
#include <engine/memory_arena.h>
#include <engine/platform/file_io.h>
#include <engine/platform/memory_allocations.h>
#include <engine/memory_pool.h>
#include <engine/platform/window_data.h>
#include <engine/platform/input_data.h>
#include <engine/string_utils.h>
#include <engine/platform/crossplatform_alloca.h>

#include <external/stb_image_write.h>

#include <stdio.h>

PointerTable* GameMemory = NULL;

int main() {
// int main(int argc, char *argv[]) {
	Error err;

	GameMemory = InitializePool();
	assert(GameMemory);

    InitializeWindow(
    	getRegion(GameMemory, WINDOW_DATA),
     	800,
      	600,
       	144,
        true,
        true,
        (v4){.arr = {0.18f, 0.20f, 0.25f, 1.0f}},
        "Der Spiel!",
        CURSOR_NORMAL
    );

    InitializeInput(
   		getRegion(GameMemory, INPUT_DATA),
   		getRegion(GameMemory, WINDOW_DATA)
    );

    err = InitializeGameScene(
    	"stub",
     	"stub"
    );
    assert(err == OK);

    err = InitializeLoadingScreenScene(
     	"stub",
      	"stub"
    );
    assert(err == OK);

    // just experimenting with loading fonts into memory
    // to be moved elsewhere
    {
   		FileData file;
     	readEntireTextFile("../../assets/fonts/bdf/cherry-11-r.bdf", &file);
      	Font f = InitializeFont(file);
       	printf("space needed for cherry-11-r.bdf = %llu\n", (llu)GetSizeForEntireFont(&f));

        Font* font = alloca(GetSizeForEntireFont(&f));


		*font = f;
        InitializeCharacterDataOntoFont(font, file);

        freeEntireTextFile(file);

        stbi_write_png("./cherryfont.png", (i32)bitmapW(font), (i32)bitmapH(font), 1, font->characterBitmap, (i32)bitmapW(font));
    }

    GameLoop(GameMemory);

	printf("amount of memory regions in enum %d\n", AMOUNT_OF_ENGINE_MEMORY_REGIONS);
	// InitializeGameState()
	// LoadSceneFromDisk();
}
